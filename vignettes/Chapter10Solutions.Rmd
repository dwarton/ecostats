---
title: "Chapter 10 - Analysing discrete data - the generalised linear model - Exercise solutions and Code Boxes"
author: "David Warton"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Chapter 10 - Analysing discrete data - the generalised linear model - Exercise solutions and Code Boxes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Exercise 10.1: Crabs on seaweed
*David and Alistair... observed the following presence (`+`) / absence (`-`)} patterns for crabs (across 10 replicates):*

Time       Distance (m)         Crabs
---------  -------------        ----------
5          0                    -
5          0                    +
5          0                    +
5          0                    -
5          0                    -
5          2                    -
5          2                    -
5          2                    +
5          2                    -
5          2                    -
...        ...                  ...
10         10                   +

*They would like to know if there is any evidence of a difference in crab presence patterns with Distance of Isolation. How should they analyse the data?*

They are looking for evidence of a difference at different values of `Dist` so will be wanting to do a hypothesis test. Because they have presence-absence data they should be thinking of a generalised linear model with binomial response, as in Code Box 10.1.


## Exercise 10.2: Do offshore wind farms affect fish communities?
*Lena and colleagues... [were] collecting paired data before and after wind farm construction, at 36 stations in each of three zones (`Wind Farm`, `North`, or `South`):*

Zone         Impact    Station    Abundance
----------   -------   --------   ----------
Wind Farm    Before    WF1        0
Wind Farm    After     WF1        0
South        Before    S1         5
South        After     S1         0
North        Before    N1         0
North        After     N1         0
Wind Farm    Before    WF2        1
Wind Farm    After     WF2        1
...          ...       ...        ...
North        After     N36        0
---------    -------   --------   ----------

*Lena wants to know if there is any evidence of a change in eel abundance at wind farm stations, as compared to others, following construction of the wind farm. How should she analyse the data?*

She is looking for evidence of a difference across different values of `Zone` when `Impact=After` so will be wanting to do a hypothesis test. This is a BACI design, so she would be particularly interested in the `Zone:Impact` interaction. Because she has count data with plenty of zeros, this should be analysed using a generalised linear model (assuming a negative binomial or Poisson response, as in Code Box 10.1).


## Exercise 10.3: Invertebrate response to bush regeneration}
*Anthony wants to evaluate how well invertebrate communities are re-establishing following bush regeneration efforts.*

 Treatment |    Count
 --------- |  -------
 C         |        0
 R         |        3
 R         |        1
 R         |        3
 C         |        1
 R         |        2
 R         |       12
 R         |        1
 R         |       18
 R         |        0

*He wants to know if there is any evidence that bush regeneration is working. How should he analyse the data?*

He is looking for evidence of an effect of revegetation so will be wanting to do a hypothesis test for a `Treatment` effect. Because he has count data, with zeros, this should be analysed using a generalised linear model (assuming a negative binomial or Poisson response, as in Code Box 10.1).


## Code Box 10.1: Example GLM fits for Exercises 10.1-3.}
For Exercise 10.1:
```{r box10.1.1}
library(ecostats)
data(seaweed)
seaweed$CrabPres = seaweed$Crab>0
ft_crab = glm(CrabPres~Time*Dist, family=binomial("cloglog"),
             data=seaweed)
```

For Exercise 10.2:
\begin{verbatim}
```{r box10.1.2}
data(windFarms)
eels = windFarms$abund[,16]
ft_eels = glm(eels~Station+Year*Zone,family="poisson",
             data=windFarms$X)
```

For Exercise 10.3:
```{r box10.1.3}
data(reveg)
Haplotaxida=reveg$abund[,12]
library(mvabund)
worms = reveg$abund$Haplotaxida
ft_worms = manyglm(worms~treatment,family="negative.binomial", data=reveg)
```

## Code for Fig. 10.5
```{r fig10.5,fig.height=8,fig.width=8}
data(reveg)
library(mvabund)
revegMV=mvabund(reveg$abund)
treatment=reveg$treatment
meanvar.plot(revegMV~treatment,legend=T,col=c("darkorange","darkgreen"),main="Poisson")
x=10^(seq(-1,3.8,length=100))
lines(x,x,type="l",col="red")

meanvar.plot(revegMV~treatment,legend=T,col=c("darkorange","darkgreen"), main="Negative binomial")
x=10^(seq(-1,3.8,length=100))
points(x,x+x^2,type="l",col="darkblue")
```

## Code Box 10.2: A summary of a GLM fit to the crab presence-absence data of Exercise 10.1

```{r box 10.2}
data(seaweed)
seaweed$CrabPres = seaweed$Crab>0
seaweed$Dist = as.factor(seaweed$Dist)
ft_crab = glm(CrabPres~Time*Dist, family=binomial("cloglog"),
             data=seaweed)
summary(ft_crab)
```


## Code Box 10.3: Dunn-Smyth residual plots for the crab data, using the `mvabund` package
```{r box10.3}
library(mvabund)
ftMany.crab = manyglm(CrabPres~Time*Dist,family=binomial("cloglog"),
             data=seaweed)
plot(ftMany.crab)
```


## Exercise 10.4: Counts of Ostracods in habitat configuration experiment.

*What sort of model would you use for Ostracod counts?*

```{r ex10.4,fig.width=6,fig.height=6}
data(seaweed)
with(seaweed,boxplot(Ost~Dist))
```

As this is a count variable with plenty of small counts (and zeros in each category), I am thinking a GLM. To start with we could consider a Poisson regression, if there were no overdispersion, or negative binomial regression.

The terms to add to the model I guess are `Time` and `Dist`, as orthogonal factors. As previously `Wmass` might also be useful.

*How would you check assumptions?*

Look for a fan-shape on a residual plot to check the mean-variance assumption, as in Code Box 10.4.


## Code Box 10.4: Assumption checking for Ostracod counts of Exercise 10.4.}

```{r box10.4, fig.width=7}
ft_countOst=manyglm(Ost~log(Wmass)+Time*Dist,data=seaweed,
             family="poisson")
plot(ft_countOst,which=1:2) # for a normal quantile plot as well
```

## Exercise 10.5: Checking the Poisson assumption on the wind farm data.

*Refit the model using the `manyglm` function, and hence construct a residual plot*

```{r ex10.5, fig.width=7}
data(windFarms)
eels = windFarms$abund[,16]
ft_eels = manyglm(eels~Station+Year*Zone,family="poisson",
             data=windFarms$X)
plot(ft_eels, which=1:2)
```

*Does the Poisson assumption look reasonable?*

There is no evidence of a fan shape, residuals are close to a straight line on the normal quantile plot, so it looks pretty good to me.


## Exercise 10.6: Checking the Poisson assumption for the worm counts.}\label{ex:revegResids}

*Refit the model using the `manyglm` function under the Poisson assumption, and hence construct a residual plot.*

```{r box 10.6Poisson, fig.width=7}
data(reveg)
Haplotaxida=reveg$abund[,12]
worms = reveg$abund$Haplotaxida
ft_worms = manyglm(worms~treatment,family=poisson(), data=reveg)
plot(ft_worms, which=1:2)
```

*Also fit a negative binomial to the data and construct a residual plot.*
```{r box 10.6NB, fig.width=7}
ft_wormsNB = manyglm(worms~treatment,family="negative.binomial", data=reveg)
plot(ft_wormsNB, which=1:2)
```

*Can you see any differences between plots?*

It is hard to see anything here, but the Poisson model fans out more and has a few residuals away from the line.

*Compare BIC for the two models, using the `BIC` function.*

```{r ex10.6 bic}
BIC(ft_worms, ft_wormsNB)
```

*Which model has the better fit to the worm counts?*

Well BIC suggests the negative binomial model is way better, corroborating the result from the normal quantile plots.

